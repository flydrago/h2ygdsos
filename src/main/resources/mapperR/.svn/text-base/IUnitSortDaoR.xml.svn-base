<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.h2y.os.dao.read.IUnitSortDaoR">

	<resultMap type="java.util.Map" id="unitsortDaoMap">
		<result property="id" column="id" javaType="long" jdbcType="BIGINT" />
		<result property="parentId" column="parent_id" javaType="long" jdbcType="BIGINT" />
		<result property="sortCode" column="sort_code" javaType="string" jdbcType="VARCHAR" />
		<result property="sortName" column="sort_name" javaType="string" jdbcType="VARCHAR" />
		<result property="createDate" column="create_date" javaType="date" jdbcType="TIMESTAMP" />
		<result property="updateDate" column="update_date" javaType="date" jdbcType="TIMESTAMP" />
		<result property="memo" column="memo" javaType="string" jdbcType="VARCHAR" />
		<result property="status" column="status" javaType="int" jdbcType="INTEGER" />
		<result property="sortPrefix" column="sort_prefix" javaType="string" jdbcType="VARCHAR" />
		<result property="ord" column="ord" javaType="long" jdbcType="BIGINT" />
	</resultMap>
	



	<!-- 获取分类 -->
	<select id="getListMap" parameterType="hashmap" resultMap="unitsortDaoMap">
		select
		*
		from
		tb_unit_sort
			<trim prefix="WHERE" prefixOverrides="AND |OR ">
					status=0
				<if test="parentId!= null and parentId!=''">
					and parent_id = #{parentId}
				</if>										
			</trim>
		order by ord desc
	</select>

	<!-- 获取筛选条件 距离 -->
	<select id="getConditionListMap" parameterType="hashmap" resultType="hashmap">
		select
		*
		from
		tb_shoplife_condition
			<trim prefix="WHERE" prefixOverrides="AND |OR ">
					status=0 
				<if test="conditionValue!= null and conditionValue!=''">
					and condition_value=#{conditionValue}
				</if>
				<if test="parentId!= null and parentId!=''">
					and parent_id = #{parentId}
				</if>										
			</trim>
		order by ord desc
	</select>
	
	
	<select id="getShopListBySort" parameterType="hashmap" resultType="hashmap">
		select d.*,
		CONCAT('?bn=sysUnitsServiceDown&amp;id=',CAST(u.id AS CHAR)) as img
		<choose>
			<when test="latitude!= null and latitude !='' and longitude != null and longitude != ''">
				,getDistance(gps_latitude,gps_longitude,#{latitude},#{longitude}) AS distance
			</when>
			<otherwise>
				,0 AS distance
			</otherwise>
		</choose>		
		from tb_sys_department d,tb_sys_units u
		<trim prefix="WHERE" prefixOverrides="AND |OR "> 
			d.dept_type = 1 and u.id=d.unit_id
			and u.zone_code like #{zoneCode}
			and IFNULL(u.stop_date,now())&gt;=now()
			and u.unit_status = 'pass'
			and u.unit_type = 1
			and d.reverse_1 &lt;&gt; 'virtual'
			<if test="shopName!= null and shopName!=''">
					and d.dept_name like #{shopName}
			</if>	
			
			<if test="sortId!= null and sortId !=0 and parentId == 0">	
					and u.id in (
						select distinct  r.unit_id 
						from tb_unit_sort s,tb_unit_sort_rt r where r.status=0 and s.status=0 and s.id=r.sort_id				
						and s.id in (select id from tb_unit_sort where status = 0 and parent_id = #{sortId})
					)
			</if>
			<if test="sortId!= null and sortId !=0 and parentId != 0">
					and u.id in (
						select distinct  r.unit_id 
						from tb_unit_sort s,tb_unit_sort_rt r where r.status=0 and s.status=0 and s.id=r.sort_id
						and s.id in (#{sortId})
					)
			</if>
			
		</trim>
		<choose>
			<when test="sortname !=null and sortname !=''">
				order by ${sortname}
				<if test="sortorder !=null and sortorder !='' ">
					${sortorder} 
				</if>
			</when>
			<otherwise>
				order by distance asc, dept_ord asc
			</otherwise>
		</choose>
				
		limit ${(page-1)*pagesize},${pagesize}
	</select>
	
	
	<!-- 生活+列表 -->
	<select id="getLifeShopList2_1" parameterType="hashmap" resultType="hashmap">
		select d.*,
		s.approve_level,s.is_approve,s.is_jyd,s.is_park,s.is_reservation,
		s.is_wifi,s.person_cost,s.shop_phone,s.shop_tel,u.unit_kind,
		if(is_spread=1 and spread_end_date &gt;= now() and spread_start_date &lt;= now(),1,0) as is_spread,
		(select t1.sort_name from tb_unit_sort t1,tb_unit_sort_rt t2 where t1.id=t2.sort_id and t2.unit_id = d.unit_id and t1.status=0 and t2.status=0) as sort_name,
		CONCAT('?bn=localServiceDown&amp;id=',CAST(f.id AS CHAR)) as img
		<choose>
			<when test="latitude!= null and latitude !='' and longitude != null and longitude != ''">
				,getDistance(gps_latitude,gps_longitude,#{latitude},#{longitude}) AS distance
			</when>
			<otherwise>
				,0 AS distance
			</otherwise>
		</choose>						
		from tb_sys_department d
		JOIN tb_sys_units u ON u.id=d.unit_id
		JOIN tb_sys_shop_info s ON d.id = s.shop_id
		JOIN tb_sys_shop_file f ON d.id = f.shop_id
		<trim prefix="WHERE" prefixOverrides="AND |OR "> 
			d.dept_type = 1 
			and d.if_delete=0
			and d.reverse_1 &lt;&gt; 'virtual'
			and u.zone_code like #{zoneCode}
			and IFNULL(u.stop_date,now())&gt;=now()
			and u.unit_status = 'pass'
			and u.unit_type = 1
			and f.ord = 2  AND f.file_type = 0 and f.status = 0
						
			<if test="shopName!= null and shopName!=''">
				and d.dept_name like #{shopName}
			</if>
			
			<if test="isWifi!= null and isWifi!=''">
				and s.is_wifi = #{isWifi}
			</if>
			<if test="isPark!= null and isPark!=''">
				and s.is_park = #{isPark}
			</if>
			<if test="isReservation!= null and isReservation!=''">
				and s.is_reservation = #{isReservation}
			</if>
			<if test="isJyd!= null and isJyd!=''">
				and s.is_jyd = #{isJyd}
			</if>
			<if test="isApprove!= null and isApprove!=''">
				and s.is_approve = #{isApprove}
			</if>
			<if test="isSpread!= null and isSpread!=''">
				and s.is_spread = #{isSpread}
			</if>
			
			<if test="sortId!= null and sortId !=0 and parentId == 0">	
					and u.id in (
						select distinct  r.unit_id 
						from tb_unit_sort s,tb_unit_sort_rt r where r.status=0 and s.status=0 and s.id=r.sort_id				
						and s.id in (select id from tb_unit_sort where status = 0 and parent_id = #{sortId})
					)
			</if>
			<if test="sortId!= null and sortId !=0 and parentId != 0">
					and u.id in (
						select distinct  r.unit_id 
						from tb_unit_sort s,tb_unit_sort_rt r where r.status=0 and s.status=0 and s.id=r.sort_id
						and s.id in (#{sortId})
					)
			</if>
			
			
			<if test="distance!= null and distance !=0 and distance !='' ">
					and getDistance (
						gps_latitude,
						gps_longitude ,#{latitude},#{longitude}
					)&lt;=#{distance}
			</if>
			
		</trim>
		<choose>
			<when test="sortname !=null and sortname !=''">
				order by ${sortname}
				<if test="sortorder !=null and sortorder !='' ">
					${sortorder} 
				</if>
			</when>
			<otherwise>
				order by is_spread desc, distance asc, dept_ord asc
			</otherwise>
		</choose>
				
		limit ${(page-1)*pagesize},${pagesize}
	</select>
	
	
	
</mapper>